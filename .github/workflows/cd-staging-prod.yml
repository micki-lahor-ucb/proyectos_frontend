name: CD Frontend - Staging + Production

on:
  push:
    branches:
      - 'main'
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build Frontend Artifact
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint:check

      - name: Run tests
        run: npm run test

      - name: Build frontend
        run: npm run build

      - name: Create RELEASE_ID
        run: |
          RELEASE_ID=$(date +%Y%m%d_%H%M%S)_${GITHUB_SHA:0:7}
          echo "$RELEASE_ID" > RELEASE_ID
          echo "RELEASE_ID=$RELEASE_ID" >> $GITHUB_ENV
          echo "Created RELEASE_ID: $RELEASE_ID"

      - name: Create release metadata
        run: |
          cat > dist/release-info.json <<EOF
          {
            "releaseId": "${{ env.RELEASE_ID }}",
            "commit": "${GITHUB_SHA}",
            "branch": "${GITHUB_REF_NAME}",
            "buildDate": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "version": "${GITHUB_REF_NAME}"
          }
          EOF
          cat dist/release-info.json

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-release-${{ github.ref_name }}
          path: |
            dist
            RELEASE_ID
          retention-days: 30

  deploy_staging:
    name: Deploy to Staging
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    needs: [build]
    environment:
      name: staging-frontend
    steps:
      - uses: actions/checkout@v4

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-release-${{ github.ref_name }}
          path: ./artifact

      - name: Read RELEASE_ID
        id: release
        run: |
          RELEASE_ID=$(cat ./artifact/RELEASE_ID | tr -d '\n')
          echo "RELEASE_ID=$RELEASE_ID" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Deploying frontend release: $RELEASE_ID"

      - name: Prepare deployment structure
        run: |
          echo "ğŸš€ Simulating deployment to STAGING environment"
          echo "================================================"
          echo "Release ID: ${{ steps.release.outputs.RELEASE_ID }}"
          echo "Target: /var/www/frontend/releases/${{ steps.release.outputs.RELEASE_ID }}"
          echo "Environment: staging-frontend"
          echo ""
          
      - name: Deploy frontend to staging (Simulated)
        run: |
          echo "ğŸ“ Creating release directory..."
          mkdir -p ./staging-deployment/releases/${{ steps.release.outputs.RELEASE_ID }}
          
          echo "ğŸ“¦ Extracting artifact..."
          cp -r ./artifact/dist/* ./staging-deployment/releases/${{ steps.release.outputs.RELEASE_ID }}/
          
          echo "ğŸ”— Creating atomic symlink..."
          cd ./staging-deployment
          ln -sfn releases/${{ steps.release.outputs.RELEASE_ID }} current
          
          echo "âœ… Symlink created: current -> $(readlink current)"
          echo ""
          echo "ğŸ“Š Deployment structure:"
          ls -la
          echo ""
          echo "ğŸ“ Current release content:"
          ls -la current/ | head -10

      - name: Verify staging deployment
        run: |
          echo "ğŸ¥ Running health checks..."
          echo "âœ… Frontend staging health check: OK (200)"
          echo "âœ… Release info accessible"
          echo ""
          echo "ğŸ“Š Release Info:"
          cat ./artifact/dist/release-info.json | jq '.'
          echo ""
          echo "âœ… STAGING deployment successful!"

  deploy_production:
    name: Deploy to Production
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    needs: [deploy_staging]
    environment:
      name: production-frontend
    steps:
      - uses: actions/checkout@v4

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-release-${{ github.ref_name }}
          path: ./artifact

      - name: Read RELEASE_ID
        id: release
        run: |
          RELEASE_ID=$(cat ./artifact/RELEASE_ID | tr -d '\n')
          echo "RELEASE_ID=$RELEASE_ID" >> $GITHUB_OUTPUT
          echo "ğŸš€ Deploying frontend to PRODUCTION: $RELEASE_ID"

      - name: Deploy frontend to production (Simulated)
        run: |
          echo "ğŸš€ Deploying to PRODUCTION environment"
          echo "================================================"
          echo "Release ID: ${{ steps.release.outputs.RELEASE_ID }}"
          echo "Target: /var/www/frontend/releases/${{ steps.release.outputs.RELEASE_ID }}"
          echo "Environment: production-frontend"
          echo ""
          
          echo "ğŸ“ Creating PRODUCTION release directory..."
          mkdir -p ./production-deployment/releases/${{ steps.release.outputs.RELEASE_ID }}
          
          echo "ğŸ“¦ Extracting artifact to PRODUCTION..."
          cp -r ./artifact/dist/* ./production-deployment/releases/${{ steps.release.outputs.RELEASE_ID }}/
          
          echo "ğŸ”— Creating atomic symlink in PRODUCTION..."
          cd ./production-deployment
          ln -sfn releases/${{ steps.release.outputs.RELEASE_ID }} current
          
          echo "âœ… PRODUCTION Symlink created: current -> $(readlink current)"
          echo ""
          echo "ğŸ“Š PRODUCTION Deployment structure:"
          ls -la
          echo ""
          echo "ğŸ“ PRODUCTION Current release content:"
          ls -la current/ | head -10

      - name: Verify production deployment
        run: |
          echo "ğŸ¥ Running PRODUCTION health checks..."
          echo "âœ… Frontend production health check: OK (200)"
          echo "âœ… Release info accessible"
          echo ""
          echo "ğŸ“Š PRODUCTION Release Info:"
          cat ./artifact/dist/release-info.json | jq '.'
          echo ""
          echo "âœ… PRODUCTION deployment successful!"
          echo ""
          echo "ğŸ‰ Frontend is now live in PRODUCTION!"

  rollback_staging:
    name: Rollback Staging
    if: failure() && needs.deploy_staging.result == 'failure'
    runs-on: ubuntu-latest
    needs: [deploy_staging]
    environment:
      name: staging-frontend
    steps:
      - name: Rollback to previous release (Simulated)
        run: |
          echo "ğŸ”„ Initiating ROLLBACK for staging frontend..."
          echo "================================================"
          echo ""
          echo "ğŸ“‹ Identifying previous stable release..."
          echo "Previous release: 20260127_120000_abc1234"
          echo ""
          echo "ğŸ”— Rolling back symlink..."
          echo "ln -sfn /var/www/frontend/releases/20260127_120000_abc1234 /var/www/frontend/current"
          echo ""
          echo "âœ… Staging frontend rolled back successfully"
          echo "Current symlink now points to: 20260127_120000_abc1234"

  rollback_production:
    name: Rollback Production
    if: failure() && needs.deploy_production.result == 'failure'
    runs-on: ubuntu-latest
    needs: [deploy_production]
    environment:
      name: production-frontend
    steps:
      - name: Rollback to previous release (Simulated)
        run: |
          echo "ğŸ”„ Initiating ROLLBACK for PRODUCTION frontend..."
          echo "================================================"
          echo ""
          echo "ğŸ“‹ Identifying previous stable PRODUCTION release..."
          echo "Previous release: 20260127_120000_abc1234"
          echo ""
          echo "ğŸ”— Rolling back PRODUCTION symlink..."
          echo "ln -sfn /var/www/frontend/releases/20260127_120000_abc1234 /var/www/frontend/current"
          echo ""
          echo "âœ… PRODUCTION frontend rolled back successfully"
          echo "Current symlink now points to: 20260127_120000_abc1234"
